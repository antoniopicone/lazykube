#---------------------------------------------------------------------
# HAProxy configuration for K3s HA cluster
# Generated by Ansible - DO NOT EDIT MANUALLY
#---------------------------------------------------------------------

global
    log /dev/log local0
    log /dev/log local1 notice
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    maxconn 4096

    # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

    # Security hardening
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

#---------------------------------------------------------------------
# HAProxy Stats Dashboard
#---------------------------------------------------------------------
listen stats
    bind *:{{ haproxy_stats_port }}
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats realm HAProxy\ Statistics
    stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_password }}
    stats admin if TRUE

#---------------------------------------------------------------------
# K3s API Server (6443) - Load balancing tra i 3 masters
#---------------------------------------------------------------------
frontend k3s_api_frontend
    bind *:6443
    mode tcp
    option tcplog
    default_backend k3s_api_backend

backend k3s_api_backend
    mode tcp
    balance roundrobin
    option tcp-check
    # Health check: verifica che la porta 6443 risponda
{% for ip in master_ips[:3] %}
    server master{{ loop.index }} {{ ip }}:6443 check inter 2000 fall 3 rise 2
{% endfor %}

#---------------------------------------------------------------------
# HTTP (80) - Traefik NodePort 32080
#---------------------------------------------------------------------
frontend http_frontend
    bind *:80
    mode tcp
    option tcplog
    default_backend http_backend

backend http_backend
    mode tcp
    balance roundrobin
    option tcp-check
{% for ip in master_ips[:3] %}
    server master{{ loop.index }} {{ ip }}:32080 check inter 2000 fall 3 rise 2
{% endfor %}

#---------------------------------------------------------------------
# HTTPS (443) - Traefik NodePort 32443
#---------------------------------------------------------------------
frontend https_frontend
    bind *:443
    mode tcp
    option tcplog
    default_backend https_backend

backend https_backend
    mode tcp
    balance roundrobin
    option tcp-check
    # SNI passthrough - HAProxy non decripta il traffico SSL
{% for ip in master_ips[:3] %}
    server master{{ loop.index }} {{ ip }}:32443 check inter 2000 fall 3 rise 2
{% endfor %}

#---------------------------------------------------------------------
# etcd Client (2379) - Per backup/restore esterni (opzionale)
#---------------------------------------------------------------------
frontend etcd_client_frontend
    bind *:2379
    mode tcp
    option tcplog
    default_backend etcd_client_backend

backend etcd_client_backend
    mode tcp
    balance leastconn
    option tcp-check
{% for ip in master_ips[:3] %}
    server master{{ loop.index }} {{ ip }}:2379 check inter 5000 fall 3 rise 2
{% endfor %}

#---------------------------------------------------------------------
# etcd Peer (2380) - Comunicazione tra nodi etcd (opzionale)
#---------------------------------------------------------------------
frontend etcd_peer_frontend
    bind *:2380
    mode tcp
    option tcplog
    default_backend etcd_peer_backend

backend etcd_peer_backend
    mode tcp
    balance leastconn
    option tcp-check
{% for ip in master_ips[:3] %}
    server master{{ loop.index }} {{ ip }}:2380 check inter 5000 fall 3 rise 2
{% endfor %}
