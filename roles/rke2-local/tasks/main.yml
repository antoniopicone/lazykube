---
# Role - Installation of RKE2 HA cluster (local network)

- name: Check if RKE2 is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/rke2
  register: rke2_binary

- name: Get primary network interface
  ansible.builtin.shell: |
    ip route get 8.8.8.8 | grep -oP 'dev \K\S+' | head -n1
  register: primary_interface
  changed_when: false
  failed_when: false

- name: Get node IP address from primary interface
  ansible.builtin.shell: |
    ip -4 addr show {{ primary_interface.stdout | default('eth0') }} | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -n1
  register: node_ip_result
  changed_when: false
  failed_when: false
  when: primary_interface.rc == 0

- name: Set node IP from inventory if auto-detection failed
  ansible.builtin.set_fact:
    node_ip: "{{ ansible_host }}"
  when: primary_interface.rc != 0 or node_ip_result is not defined or node_ip_result.rc != 0 or node_ip_result.stdout == ""

- name: Set node IP from command result
  ansible.builtin.set_fact:
    node_ip: "{{ node_ip_result.stdout }}"
  when: node_ip_result is defined and node_ip_result.rc == 0 and node_ip_result.stdout != ""

- name: Display node IP
  ansible.builtin.debug:
    msg: "Node {{ k3s_node_name }} will use IP: {{ node_ip }}"

# Create RKE2 config directory
- name: Create RKE2 config directory
  ansible.builtin.file:
    path: "{{ rke2_config_dir }}"
    state: directory
    mode: '0755'

# Install first master node
- name: Install first RKE2 master with cluster-init
  when:
    - is_first_master | default(false)
    - not rke2_binary.stat.exists
  block:
    - name: Create RKE2 config for first master
      ansible.builtin.template:
        src: rke2-config-first.yaml.j2
        dest: "{{ rke2_config_dir }}/config.yaml"
        mode: '0600'

    - name: Download and install RKE2 (first master)
      ansible.builtin.shell: |
        curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE=server sh -
      args:
        creates: /usr/local/bin/rke2
      register: rke2_install
      retries: 3
      delay: 10

    - name: Enable RKE2 server service
      ansible.builtin.systemd:
        name: rke2-server
        enabled: true
        daemon_reload: true

    - name: Start RKE2 server
      ansible.builtin.systemd:
        name: rke2-server
        state: started
      register: rke2_start
      retries: 3
      delay: 10
      until: rke2_start is succeeded

    - name: Wait for RKE2 to be ready
      ansible.builtin.wait_for:
        path: "{{ rke2_config_dir }}/rke2.yaml"
        state: present
        timeout: 300

    - name: Wait for node-token to be created
      ansible.builtin.wait_for:
        path: "{{ rke2_data_dir }}/server/node-token"
        state: present
        timeout: 180

    - name: Get RKE2 node token
      ansible.builtin.slurp:
        src: "{{ rke2_data_dir }}/server/node-token"
      register: rke2_token_encoded

    - name: Set RKE2 token fact
      ansible.builtin.set_fact:
        rke2_node_token: "{{ rke2_token_encoded.content | b64decode | trim }}"

    - name: Save token to local file
      ansible.builtin.copy:
        content: "{{ rke2_node_token }}"
        dest: "/tmp/rke2-token-local"
        mode: '0600'
      delegate_to: localhost
      become: false

    - name: Create kubectl symlink
      ansible.builtin.file:
        src: /var/lib/rancher/rke2/bin/kubectl
        dest: /usr/local/bin/kubectl
        state: link
        force: yes

    - name: Create crictl symlink
      ansible.builtin.file:
        src: /var/lib/rancher/rke2/bin/crictl
        dest: /usr/local/bin/crictl
        state: link
        force: yes

    - name: Wait for RKE2 API to be ready
      ansible.builtin.shell: |
        export KUBECONFIG={{ rke2_config_dir }}/rke2.yaml
        /var/lib/rancher/rke2/bin/kubectl get --raw='/readyz?verbose' 2>/dev/null || echo "waiting"
      register: api_check
      changed_when: false
      until: api_check.rc == 0
      retries: 60
      delay: 5

# Install additional master nodes
- name: Install additional RKE2 masters
  when:
    - not (is_first_master | default(false))
    - not rke2_binary.stat.exists
  block:
    - name: Wait for token file to exist
      ansible.builtin.wait_for:
        path: "/tmp/rke2-token-local"
        state: present
        timeout: 300
      delegate_to: localhost
      become: false

    - name: Read RKE2 token from local file
      ansible.builtin.slurp:
        src: "/tmp/rke2-token-local"
      delegate_to: localhost
      become: false
      register: token_file

    - name: Set token fact
      ansible.builtin.set_fact:
        rke2_join_token: "{{ token_file.content | b64decode | trim }}"

    - name: Get first master IP
      ansible.builtin.set_fact:
        first_master_ip: "{{ master_ips[0] }}"

    - name: Create RKE2 config for additional masters
      ansible.builtin.template:
        src: rke2-config-join.yaml.j2
        dest: "{{ rke2_config_dir }}/config.yaml"
        mode: '0600'

    - name: Download and install RKE2 (additional masters)
      ansible.builtin.shell: |
        curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE=server sh -
      args:
        creates: /usr/local/bin/rke2
      register: rke2_install
      retries: 3
      delay: 10

    - name: Enable RKE2 server service
      ansible.builtin.systemd:
        name: rke2-server
        enabled: true
        daemon_reload: true

    - name: Start RKE2 server
      ansible.builtin.systemd:
        name: rke2-server
        state: started
      register: rke2_start
      retries: 3
      delay: 10
      until: rke2_start is succeeded

    - name: Wait for RKE2 to be ready
      ansible.builtin.wait_for:
        path: "{{ rke2_config_dir }}/rke2.yaml"
        state: present
        timeout: 300

    - name: Create kubectl symlink
      ansible.builtin.file:
        src: /var/lib/rancher/rke2/bin/kubectl
        dest: /usr/local/bin/kubectl
        state: link
        force: yes

    - name: Create crictl symlink
      ansible.builtin.file:
        src: /var/lib/rancher/rke2/bin/crictl
        dest: /usr/local/bin/crictl
        state: link
        force: yes

- name: Wait for at least one node to be ready
  ansible.builtin.shell: |
    export KUBECONFIG={{ rke2_config_dir }}/rke2.yaml
    /var/lib/rancher/rke2/bin/kubectl get nodes --no-headers 2>/dev/null | grep -c Ready || echo "0"
  register: ready_nodes
  changed_when: false
  until: ready_nodes.stdout | int > 0
  retries: 60
  delay: 5
  when: is_first_master | default(false)

- name: Display nodes status
  ansible.builtin.shell: |
    export KUBECONFIG={{ rke2_config_dir }}/rke2.yaml
    /var/lib/rancher/rke2/bin/kubectl get nodes
  register: nodes_status
  changed_when: false
  when: is_first_master | default(false)

- name: Show nodes
  ansible.builtin.debug:
    msg: "{{ nodes_status.stdout_lines }}"
  when: is_first_master | default(false)

# Fetch kubeconfig to local machine (only from first master)
- name: Fetch kubeconfig to local machine
  when: is_first_master | default(false)
  block:
    - name: Read kubeconfig
      ansible.builtin.slurp:
        src: "{{ rke2_config_dir }}/rke2.yaml"
      register: kubeconfig_content

    - name: Save kubeconfig locally
      ansible.builtin.copy:
        content: "{{ kubeconfig_content.content | b64decode }}"
        dest: "{{ local_kubeconfig_path }}"
        mode: '0600'
      delegate_to: localhost
      become: false

    - name: Update kubeconfig server to use HAProxy
      ansible.builtin.replace:
        path: "{{ local_kubeconfig_path }}"
        regexp: 'https://127\.0\.0\.1:6443'
        replace: 'https://{{ haproxy_ip }}:{{ rke2_api_port }}'
      delegate_to: localhost
      become: false

    - name: Customize kubeconfig for {{ domain }} cluster
      ansible.builtin.shell: |
        # Use sed to rename all 'default' entries to '{{ domain }}'
        sed -i.bak \
          -e 's/name: default$/name: {{ domain }}/g' \
          -e 's/cluster: default$/cluster: {{ domain }}/g' \
          -e 's/user: default$/user: {{ domain }}/g' \
          -e 's/current-context: default$/current-context: {{ domain }}/g' \
          "{{ local_kubeconfig_path }}"

        # Remove backup file
        rm -f "{{ local_kubeconfig_path }}.bak"
      delegate_to: localhost
      become: false
      args:
        executable: /bin/bash

    - name: Display kubeconfig info
      ansible.builtin.debug:
        msg: |
          ========================================
          âœ… RKE2 Kubeconfig {{ domain }} generated!
          ========================================

          ðŸ“ Path: {{ local_kubeconfig_path }}

          âœ… Cluster name: {{ domain }}
          âœ… HAProxy LoadBalancer: {{ haproxy_ip }}:{{ rke2_api_port }}
          âœ… insecure-skip-tls-verify: true (avoids TLS warnings)
          âœ… Context: {{ domain }}
          âœ… User: {{ domain }}

          ========================================
          ðŸ“‹ MERGE WITH EXISTING KUBECONFIG
          ========================================

          Option 1 - Permanent merge (recommended):
          ------------------------------------------------
          # Backup current kubeconfig
          cp ~/.kube/config ~/.kube/config.backup-$(date +%Y%m%d-%H%M%S)

          # Merge and save
          KUBECONFIG=~/.kube/config:{{ local_kubeconfig_path }} kubectl config view --flatten > ~/.kube/config-merged
          mv ~/.kube/config-merged ~/.kube/config

          # Select the new cluster
          kubectl config use-context {{ domain }}

          # Verify
          kubectl get nodes

          Option 2 - Temporary merge (for testing):
          ------------------------------------------------
          export KUBECONFIG=~/.kube/config:{{ local_kubeconfig_path }}
          kubectl config use-context {{ domain }}
          kubectl get nodes

          ========================================
          ðŸ”§ TROUBLESHOOTING
          ========================================

          To switch between clusters:
          kubectl config use-context <other-context>  # Previous cluster
          kubectl config use-context {{ domain }}    # {{ domain }} cluster

          To see all available contexts:
          kubectl config get-contexts
