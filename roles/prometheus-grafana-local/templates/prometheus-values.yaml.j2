# Prometheus Stack configuration for local K3s cluster
# Domain: {{ domain }}

# Global configuration
fullnameOverride: kube-prometheus-stack

# Prometheus Operator configuration
prometheusOperator:
  enabled: true
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

# Prometheus configuration
prometheus:
  enabled: true
  prometheusSpec:
    retention: 7d
    retentionSize: "10GB"
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi
    resources:
      limits:
        cpu: 500m
        memory: 1Gi
      requests:
        cpu: 250m
        memory: 512Mi
    # Service monitors
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false
    # External URL for access via Ingress
    externalUrl: https://prometheus.{{ domain }}
    # Additional scrape configs
    additionalScrapeConfigs: []

# Grafana configuration
grafana:
  enabled: true
  adminPassword: "{{ grafana_admin_password | default('admin') }}"
  grafana.ini:
    server:
      root_url: https://grafana.{{ domain }}
    auth.anonymous:
      enabled: false
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi
  persistence:
    enabled: true
    size: 5Gi
  # Datasources - configurazione semplificata (evita duplicati)
  # Il datasource Prometheus viene creato automaticamente dal chart
  sidecar:
    datasources:
      enabled: true
      defaultDatasourceEnabled: true
  # Dashboard providers
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'default'
          orgId: 1
          folder: ''
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/default
        - name: 'kubernetes'
          orgId: 1
          folder: 'Kubernetes'
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/kubernetes
  # Pre-installed dashboards
  dashboards:
    default: {}
    kubernetes:
      k8s-cluster:
        gnetId: 7249
        revision: 1
        datasource: Prometheus
      k8s-nodes:
        gnetId: 15759
        revision: 1
        datasource: Prometheus
      k8s-pods:
        gnetId: 6417
        revision: 1
        datasource: Prometheus

# AlertManager configuration
alertmanager:
  enabled: true
  alertmanagerSpec:
    storage:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 2Gi
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi
    externalUrl: https://alertmanager.{{ domain }}
  config:
    global:
      resolve_timeout: 5m
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'null'
      routes:
        - match:
            alertname: Watchdog
          receiver: 'null'
    receivers:
      - name: 'null'
    templates: []

# Node Exporter - metrics from cluster nodes
nodeExporter:
  enabled: true

# kube-state-metrics - metrics about Kubernetes objects
kube-state-metrics:
  enabled: true

# Default rules and alerts
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: true
    configReloaders: true
    general: true
    k8s: true
    kubeApiserver: true
    kubeApiserverAvailability: true
    kubeApiserverSlos: true
    kubelet: true
    kubeProxy: true
    kubePrometheusGeneral: true
    kubePrometheusNodeRecording: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    kubeScheduler: true
    kubeStateMetrics: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true

# Service monitors for various components
kubeApiServer:
  enabled: true
kubeControllerManager:
  enabled: true
kubeScheduler:
  enabled: true
kubeProxy:
  enabled: true
kubeEtcd:
  enabled: true
  service:
    enabled: true
    port: 2379
    targetPort: 2379
