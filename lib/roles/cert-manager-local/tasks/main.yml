---
# Role: cert-manager-local - Certificati self-signed per domini locali

- name: Install Python Kubernetes dependencies via apt
  ansible.builtin.package:
    name:
      - python3-pip
      - python3-kubernetes
      - python3-yaml
    state: present
  become: true

- name: Install cert-manager CRDs and components
  kubernetes.core.k8s:
    state: present
    src: "https://github.com/cert-manager/cert-manager/releases/download/{{ cert_manager_version }}/cert-manager.yaml"
  when: is_first_master | default(false)

- name: Wait for cert-manager webhook to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: cert-manager
    label_selectors:
      - app.kubernetes.io/instance=cert-manager
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 300
  when: is_first_master | default(false)

- name: Create self-signed ClusterIssuer
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: ClusterIssuer
      metadata:
        name: selfsigned-issuer
      spec:
        selfSigned: {}
  when: is_first_master | default(false)

- name: Create CA Certificate for internal PKI
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: Certificate
      metadata:
        name: k3s-local-ca
        namespace: cert-manager
      spec:
        isCA: true
        commonName: "{{ cluster_name }}-ca"
        secretName: k3s-local-ca-secret
        duration: 87600h  # 10 years
        renewBefore: 360h  # 15 days
        subject:
          organizations:
            - "{{ cluster_name }}"
          organizationalUnits:
            - "Kubernetes Cluster"
        issuerRef:
          name: selfsigned-issuer
          kind: ClusterIssuer
          group: cert-manager.io
  when: is_first_master | default(false)

- name: Wait for CA certificate to be ready
  kubernetes.core.k8s_info:
    kind: Certificate
    name: k3s-local-ca
    namespace: cert-manager
  register: ca_cert_status
  until: ca_cert_status.resources[0].status.conditions[0].status == "True"
  retries: 30
  delay: 5
  when: is_first_master | default(false)

- name: Create CA ClusterIssuer (signed by internal CA)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: ClusterIssuer
      metadata:
        name: ca-issuer
      spec:
        ca:
          secretName: k3s-local-ca-secret
  when: is_first_master | default(false)

- name: Wait for ClusterIssuers to be ready
  kubernetes.core.k8s_info:
    kind: ClusterIssuer
    name: "{{ item }}"
  register: issuer_status
  until: issuer_status.resources[0].status.conditions[0].status == "True"
  retries: 30
  delay: 2
  loop:
    - selfsigned-issuer
    - ca-issuer
  when: is_first_master | default(false)

- name: Get CA certificate for local trust
  kubernetes.core.k8s_info:
    kind: Secret
    name: k3s-local-ca-secret
    namespace: cert-manager
  register: ca_secret
  when: is_first_master | default(false)

- name: Save CA certificate locally
  ansible.builtin.copy:
    content: "{{ ca_secret.resources[0].data['tls.crt'] | b64decode }}"
    dest: "~/.kube/k3s-local-ca.crt"
    mode: '0644'
  delegate_to: localhost
  become: false
  when: is_first_master | default(false)

- name: Display cert-manager status
  ansible.builtin.debug:
    msg: |
      cert-manager installato con successo!

      ClusterIssuers disponibili:
      - selfsigned-issuer: Per certificati self-signed singoli
      - ca-issuer: Per certificati firmati dalla CA interna (RACCOMANDATO)

      ⚠️  CERTIFICATI SELF-SIGNED PER USO LOCALE
      I certificati NON sono fidati dai browser per default.

      Per evitare warning SSL nel browser:
      1. Importa il CA certificate nel sistema:
         sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain ~/.kube/k3s-local-ca.crt

      2. Oppure accetta l'eccezione nel browser quando accedi ai servizi

      CA Certificate salvato in: ~/.kube/k3s-local-ca.crt
  when: is_first_master | default(false)
